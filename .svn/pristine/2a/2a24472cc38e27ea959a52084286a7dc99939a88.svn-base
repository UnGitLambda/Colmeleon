import os
import csv
import pickle
import Histogram.Histogram as Histogram
import Image.Image as Image

class Database:

    def __init__(self,directory):
        """
        The path to the directory is given as a String.
        """
        assert type(directory) is str, "Database: the path to the directory must be given as a String, it can not be {type(directory)}"
        assert os.path.exists(directory), "Database: The path given leads nowhere, please fix this issue before trying again."
        assert os.path.isdir(directory), "Database: The path given does not lead to a directory, please fix this issue before trying again."
        self._database = directory

    def _calculate_histograms_():
        """
        Computes all images in the database to create their histograms, then stocks them.
        """
        #TODO optimize
        files = os.listdir(_database)

        #if histograms.csv exists in the database
        if 'histograms.csv' in files :
            with open('histograms.csv','a') as csv_file :
                filewriter = csv.writer(csv_file)
                #getting the list of images already paired from the csv file
                filereader = csv.reader(csv_file)
                images_ready = [item[0] for item in list(reader)]
                #we'll consider the images that do not already have their histogram
                for file in files :
                    if (file.endswith("png") or file.endswith("pdf") or file.endswith("jpg") or file.endswith("jpeg") or file.endswith("bmp") or file.endswith("gif")) and os.path.relpath(file) not in images_ready :
                        histo = Histogram(Image(file))
                        #save the histogram in the database
                        name = file[:len(file)-3]+'hist'
                        with open(name,'w+') as histo_file:
                            pickle.dump(histo,histo_file,protocol=pickle.HIGHEST_PROTOCOL)
                        #save the paths to image and histogram in csv
                        filewriter.writerow(os.path.relpath(file),os.path.relpath(histo_file))

        #if there is no histograms.csv file already existing in the directory
        else:
            with open('histograms.csv','x') as csv_file :
                filewriter = csv.writer(csv_file)
                for file in files:
                    #we only consider valid image formats
                    if file.endswith("png") or file.endswith("pdf") or file.endswith("jpg") or file.endswith("jpeg") or file.endswith("bmp") or file.endswith("gif") :
                        histo = Histogram(Image(file))
                        #save the histogram in the database
                        name = file[:len(file)-3]+'hist'
                        with open(name,'w+') as histo_file:
                            pickle.dump(histo,histo_file,protocol=pickle.HIGHEST_PROTOCOL)
                        #save the paths to image and histogram in csv
                        filewriter.writerow(os.path.relpath(file),os.path.relpath(histo_file))

    def histograms():
        """
        Returns table of all histograms and the pointer to the associated image in the base.
        """


    def images():
        """
        Returns table containing pointers to all images in the database
        """

    def add(img,hstg):
        """
        Returns true if couple was correctly added to the database.
        """